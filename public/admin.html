<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        body {
            background-color: #bccfe6;
        }
    </style>
    <meta charset="UTF-8">
    <title>Admin</title>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
</head>
<body>
<br><br>
<div class="container">
    <input placeholder="Title" id="title" type="text">
    <input placeholder="Price" id="price" type="number">
    <input placeholder="Image URL" id="image" type="text">
    <input placeholder="Date sold (Leave blank if for sale)" id="date" type="date">
    <button id="submit">Submit</button>
    <button id="edit">Edit</button>
    <button id="delete">Delete</button> <br><br>
</div>


<div class="container" id="messages">

</div>

<script>
    const title = document.getElementById("title");
    const price = document.getElementById("price");
    const image = document.getElementById("image");
    const send = document.getElementById("submit");
    const edit = document.getElementById("edit");
    const date = document.getElementById("date");
    const deleteButton = document.getElementById("delete");
    send.addEventListener("click", function () {
        fetch('/addpost', {
            method: "POST",
            body: JSON.stringify({title: title.value, price: price.value, image: image.value, date: date.value}),
            headers: {'Content-Type': 'application/json'}
        })
    });
    edit.addEventListener("click", function () {
        fetch('/editpost', {
            method: "POST",
            body: JSON.stringify({title: title.value}),
            headers: {'Content-Type': 'application/json'}
        }).then(result => result.json()).then(result => {
            if (result !== null) {
                price.value = parseInt(result.price);
                image.value = result.image;
            } else {
                let error = document.createElement("h1");
                error.innerHTML = "Error finding post";
                document.body.appendChild(error);
            }
        })
    });
    deleteButton.addEventListener("click", function () {
        fetch("/deletepost", {
            method: "POST",
            body: JSON.stringify({title: title.value}),
            headers: {'Content-Type': 'application/json'}
        })
    });
    let messages = [];
    window.addEventListener("load", function () {
        let messagecontainer = document.getElementById("messages");
        fetch("/getmessages").then(res => res.json().then(res => {
            if (res.message === "U r not an admin, sry :/") {
                alert("U r not an admin, sry :/");
            }
            else {
                res.forEach((message) => {
                    messages.push(message);
                    let messagealert = document.createElement("div");
                    messagealert.setAttribute("class", "alert alert-primary alert-dismissible fade show");
                    messagealert.setAttribute("role", "alert");
                    let p = document.createElement("p");
                    p.innerText = "At " + message.date + ", " + message.name + " said: " + message.message + ". They want to be " + message.commMethod.toLowerCase() + "ed at " + message.comm + ".";
                    messagealert.appendChild(p);
                    let deleteButton = document.createElement("button");
                    deleteButton.setAttribute("type", "button");
                    deleteButton.setAttribute("class", "close");
                    deleteButton.setAttribute("data-dismiss", "alert");
                    deleteButton.setAttribute("aria-label", "Close");
                    deleteButton.addEventListener("click", (event) => {
                        event.preventDefault();
                        if (confirm("Are you sure you want to delete this message?")) {
                            fetch("/deletemessage", {
                                method: "POST",
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({_id: message._id})
                            }).then(res => {
                                res.json().then(res => {
                                    alert(res.message);
                                    window.location.href = '/admin.html?';
                                })
                            });
                        }
                    });
                    let spanhtml = `<span aria-hidden="true">&times;</span>`;
                    deleteButton.innerHTML = spanhtml;
                    messagealert.appendChild(deleteButton);
                    messagecontainer.appendChild(messagealert);
                });
            }
        }))
    });
</script>
</body>
</html>